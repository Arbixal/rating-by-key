// https://raider.io/api/v1/characters/profile?region=us&realm=nagrand&name=bixsham&fields=mythic_plus_best_runs%2Cmythic_plus_alternate_runs
/*
{
  "name": "Bixsham",
  "race": "Orc",
  "class": "Shaman",
  "active_spec_name": "Enhancement",
  "active_spec_role": "DPS",
  "gender": "male",
  "faction": "horde",
  "achievement_points": 10735,
  "honorable_kills": 0,
  "thumbnail_url": "https://render.worldofwarcraft.com/us/character/nagrand/19/152550419-avatar.jpg?alt=/wow/static/images/2d/avatar/2-0.jpg",
  "region": "us",
  "realm": "Nagrand",
  "last_crawled_at": "2024-01-28T12:56:08.000Z",
  "profile_url": "https://raider.io/characters/us/nagrand/Bixsham",
  "profile_banner": "hordebanner1",
  "mythic_plus_scores_by_season": [
    {
      "season": "season-df-3",
      "scores": {
        "all": 865.2,
        "dps": 797.7,
        "healer": 133.4,
        "tank": 0,
        "spec_0": 0,
        "spec_1": 797.7,
        "spec_2": 133.4,
        "spec_3": 0
      },
      "segments": {
        "all": {
          "score": 865.2,
          "color": "#56ff3c"
        },
        "dps": {
          "score": 797.7,
          "color": "#75ff59"
        },
        "healer": {
          "score": 133.4,
          "color": "#ffffff"
        },
        "tank": {
          "score": 0,
          "color": "#ffffff"
        },
        "spec_0": {
          "score": 0,
          "color": "#ffffff"
        },
        "spec_1": {
          "score": 797.7,
          "color": "#75ff59"
        },
        "spec_2": {
          "score": 133.4,
          "color": "#ffffff"
        },
        "spec_3": {
          "score": 0,
          "color": "#ffffff"
        }
      }
    }
  ],
  "mythic_plus_best_runs": [
    {
      "dungeon": "Waycrest Manor",
      "short_name": "WM",
      "mythic_level": 13,
      "completed_at": "2024-01-28T12:46:28.000Z",
      "clear_time_ms": 1440843,
      "par_time_ms": 2220999,
      "num_keystone_upgrades": 2,
      "map_challenge_mode_id": 248,
      "zone_id": 9424,
      "score": 115.4,
      "affixes": [
        {
          "id": 10,
          "name": "Fortified",
          "description": "Non-boss enemies have 20% more health and inflict up to 30% increased damage.",
          "icon": "ability_toughness",
          "wowhead_url": "https://wowhead.com/affix=10"
        },
        {
          "id": 136,
          "name": "Incorporeal",
          "description": "While in combat, incorporeal beings periodically appear and attempt to weaken players.",
          "icon": "achievement_boss_anomalus",
          "wowhead_url": "https://wowhead.com/affix=136"
        }
      ],
      "url": "https://raider.io/mythic-plus-runs/season-df-3/22691702-13-waycrest-manor"
    },
    {
      "dungeon": "DOTI: Galakrond's Fall",
      "short_name": "FALL",
      "mythic_level": 10,
      "completed_at": "2024-01-15T11:38:10.000Z",
      "clear_time_ms": 1087472,
      "par_time_ms": 2040999,
      "num_keystone_upgrades": 3,
      "map_challenge_mode_id": 463,
      "zone_id": 1000010,
      "score": 95,
      "affixes": [
        {
          "id": 10,
          "name": "Fortified",
          "description": "Non-boss enemies have 20% more health and inflict up to 30% increased damage.",
          "icon": "ability_toughness",
          "wowhead_url": "https://wowhead.com/affix=10"
        },
        {
          "id": 124,
          "name": "Storming",
          "description": "While in combat, enemies periodically summon damaging whirlwinds.",
          "icon": "spell_nature_cyclone",
          "wowhead_url": "https://wowhead.com/affix=124"
        }
      ],
      "url": "https://raider.io/mythic-plus-runs/season-df-3/19973724-10-doti-galakronds-fall"
    },
    {
      "dungeon": "Throne of the Tides",
      "short_name": "TOTT",
      "mythic_level": 9,
      "completed_at": "2024-01-15T10:22:33.000Z",
      "clear_time_ms": 1404414,
      "par_time_ms": 2040999,
      "num_keystone_upgrades": 2,
      "map_challenge_mode_id": 456,
      "zone_id": 4738,
      "score": 88.9,
      "affixes": [
        {
          "id": 10,
          "name": "Fortified",
          "description": "Non-boss enemies have 20% more health and inflict up to 30% increased damage.",
          "icon": "ability_toughness",
          "wowhead_url": "https://wowhead.com/affix=10"
        },
        {
          "id": 124,
          "name": "Storming",
          "description": "While in combat, enemies periodically summon damaging whirlwinds.",
          "icon": "spell_nature_cyclone",
          "wowhead_url": "https://wowhead.com/affix=124"
        }
      ],
      "url": "https://raider.io/mythic-plus-runs/season-df-3/19966040-9-throne-of-the-tides"
    },
    {
      "dungeon": "Darkheart Thicket",
      "short_name": "DHT",
      "mythic_level": 6,
      "completed_at": "2023-12-26T11:48:00.000Z",
      "clear_time_ms": 891252,
      "par_time_ms": 1800999,
      "num_keystone_upgrades": 3,
      "map_challenge_mode_id": 198,
      "zone_id": 7673,
      "score": 65,
      "affixes": [
        {
          "id": 9,
          "name": "Tyrannical",
          "description": "Bosses have 30% more health. Bosses and their minions inflict up to 15% increased damage.",
          "icon": "achievement_boss_archaedas",
          "wowhead_url": "https://wowhead.com/affix=9"
        }
      ],
      "url": "https://raider.io/mythic-plus-runs/season-df-3/14294875-6-darkheart-thicket"
    },
    {
      "dungeon": "The Everbloom",
      "short_name": "EB",
      "mythic_level": 5,
      "completed_at": "2023-12-12T10:51:49.000Z",
      "clear_time_ms": 1521467,
      "par_time_ms": 1980999,
      "num_keystone_upgrades": 2,
      "map_challenge_mode_id": 168,
      "zone_id": 7109,
      "score": 57.9,
      "affixes": [
        {
          "id": 9,
          "name": "Tyrannical",
          "description": "Bosses have 30% more health. Bosses and their minions inflict up to 15% increased damage.",
          "icon": "achievement_boss_archaedas",
          "wowhead_url": "https://wowhead.com/affix=9"
        }
      ],
      "url": "https://raider.io/mythic-plus-runs/season-df-3/10340965-5-everbloom"
    },
    {
      "dungeon": "Atal'Dazar",
      "short_name": "AD",
      "mythic_level": 2,
      "completed_at": "2023-12-12T12:09:53.000Z",
      "clear_time_ms": 673104,
      "par_time_ms": 1800999,
      "num_keystone_upgrades": 3,
      "map_challenge_mode_id": 244,
      "zone_id": 9028,
      "score": 45,
      "affixes": [
        {
          "id": 9,
          "name": "Tyrannical",
          "description": "Bosses have 30% more health. Bosses and their minions inflict up to 15% increased damage.",
          "icon": "achievement_boss_archaedas",
          "wowhead_url": "https://wowhead.com/affix=9"
        }
      ],
      "url": "https://raider.io/mythic-plus-runs/season-df-3/10353665-2-ataldazar"
    },
    {
      "dungeon": "Black Rook Hold",
      "short_name": "BRH",
      "mythic_level": 2,
      "completed_at": "2023-12-04T10:40:48.000Z",
      "clear_time_ms": 957206,
      "par_time_ms": 2160999,
      "num_keystone_upgrades": 3,
      "map_challenge_mode_id": 199,
      "zone_id": 7805,
      "score": 45,
      "affixes": [
        {
          "id": 10,
          "name": "Fortified",
          "description": "Non-boss enemies have 20% more health and inflict up to 30% increased damage.",
          "icon": "ability_toughness",
          "wowhead_url": "https://wowhead.com/affix=10"
        }
      ],
      "url": "https://raider.io/mythic-plus-runs/season-df-3/7645742-2-black-rook-hold"
    }
  ],
  "mythic_plus_alternate_runs": [
    {
      "dungeon": "Waycrest Manor",
      "short_name": "WM",
      "mythic_level": 8,
      "completed_at": "2023-12-26T12:24:29.000Z",
      "clear_time_ms": 1526861,
      "par_time_ms": 2220999,
      "num_keystone_upgrades": 2,
      "map_challenge_mode_id": 248,
      "zone_id": 9424,
      "score": 83.9,
      "affixes": [
        {
          "id": 9,
          "name": "Tyrannical",
          "description": "Bosses have 30% more health. Bosses and their minions inflict up to 15% increased damage.",
          "icon": "achievement_boss_archaedas",
          "wowhead_url": "https://wowhead.com/affix=9"
        },
        {
          "id": 136,
          "name": "Incorporeal",
          "description": "While in combat, incorporeal beings periodically appear and attempt to weaken players.",
          "icon": "achievement_boss_anomalus",
          "wowhead_url": "https://wowhead.com/affix=136"
        }
      ],
      "url": "https://raider.io/mythic-plus-runs/season-df-3/14300177-8-waycrest-manor"
    },
    {
      "dungeon": "DOTI: Galakrond's Fall",
      "short_name": "FALL",
      "mythic_level": 6,
      "completed_at": "2023-12-12T11:50:52.000Z",
      "clear_time_ms": 1079528,
      "par_time_ms": 2040999,
      "num_keystone_upgrades": 3,
      "map_challenge_mode_id": 463,
      "zone_id": 1000010,
      "score": 65,
      "affixes": [
        {
          "id": 9,
          "name": "Tyrannical",
          "description": "Bosses have 30% more health. Bosses and their minions inflict up to 15% increased damage.",
          "icon": "achievement_boss_archaedas",
          "wowhead_url": "https://wowhead.com/affix=9"
        }
      ],
      "url": "https://raider.io/mythic-plus-runs/season-df-3/10350862-6-doti-galakronds-fall"
    },
    {
      "dungeon": "Atal'Dazar",
      "short_name": "AD",
      "mythic_level": 2,
      "completed_at": "2023-12-04T05:28:33.000Z",
      "clear_time_ms": 721065,
      "par_time_ms": 1800999,
      "num_keystone_upgrades": 3,
      "map_challenge_mode_id": 244,
      "zone_id": 9028,
      "score": 45,
      "affixes": [
        {
          "id": 10,
          "name": "Fortified",
          "description": "Non-boss enemies have 20% more health and inflict up to 30% increased damage.",
          "icon": "ability_toughness",
          "wowhead_url": "https://wowhead.com/affix=10"
        }
      ],
      "url": "https://raider.io/mythic-plus-runs/season-df-3/7598745-2-ataldazar"
    }
  ]
}
*/

import { KeyboardEvent, MouseEvent, useState } from "react";
import "./CharacterSelector.css";
import CharacterBadge, {CharacterDetails} from "./CharacterBadge";
import { Affix } from "./CurrentAffixes";

interface RaiderIOCharacter extends RaiderIOError {
    name: string,
    class: string,
    thumbnail_url: string,
    profile_url: string,
    mythic_plus_scores_by_season: RaiderIOScoreBySeason[],
    mythic_plus_best_runs: RaiderIORun[],
    mythic_plus_alternate_runs: RaiderIORun[],
}

interface RaiderIOScoreBySeason {
    season: string,
    scores: { 
        all: number, 
        dps: number, 
        healer: number, 
        tank: number, 
        spec_0: number, 
        spec_1: number, 
        spec_2: number, 
        spec_3: number,
    }
    segments: { 
        all: RaiderIOScoreSegment,
        dps: RaiderIOScoreSegment, 
        healer: RaiderIOScoreSegment, 
        tank: RaiderIOScoreSegment, 
        spec_0: RaiderIOScoreSegment, 
        spec_1: RaiderIOScoreSegment, 
        spec_2: RaiderIOScoreSegment, 
        spec_3: RaiderIOScoreSegment,
    }
}

interface RaiderIOScoreSegment {
    score: number,
    color: string,
}

interface RaiderIOError {
    statusCode: number | null,
    error: string | null,
    message: string | null,
}

export interface RaiderIORun {
    dungeon: string,
    short_name: string,
    mythic_level: number,
    completed_at: Date,
    clear_time_ms: number,
    par_time_ms: number,
    num_keystone_upgrades: number,
    map_challenge_mode_id: number,
    zone_id: number,
    url: string,
    affixes: Affix[],
    score: number,
}

interface CharacterSelectorProps {
    onDataChange: (data: RaiderIORun[] | null) => void;
}

function CharacterSelector({onDataChange}: CharacterSelectorProps)
{
    const [character, setCharacter] = useState<string | undefined>(undefined);
    const [region, setRegion] = useState<string>("us");
    const [realm, setRealm] = useState<string | undefined>(undefined);
    const [error, setError] = useState<Error | null>(null)
    const [characterDetails, setCharacterDetails] = useState<CharacterDetails | null>(null)

    const handleKeyPress = (e: KeyboardEvent<HTMLInputElement>): void => {
        if (e.code !== "Enter" ) {
            return;
        }

        setCharacterDetails(null);
        onDataChange(null);

        fetchCharacterData();
    }
    
    const handleFetch = (e: MouseEvent<HTMLButtonElement>): void => {
        e.preventDefault();

        setCharacterDetails(null);
        onDataChange(null);
        
        fetchCharacterData();
    }

    const fetchCharacterData = () => {
        if (!character || !region || !realm) {
            return;
        }

        fetch("https://raider.io/api/v1/characters/profile?region=" + region.toLowerCase() 
            + "&realm=" + realm.toLowerCase() 
            + "&name=" + character.toLowerCase() 
            + "&fields=mythic_plus_scores_by_season%3Acurrent%2Cmythic_plus_best_runs%2Cmythic_plus_alternate_runs")
            .then(resp =>  resp.json())
            .then((result: RaiderIOCharacter) => {
                if (result.statusCode && result.statusCode !== 200) {
                    setError(new Error(result?.message ?? "An error occurred."));
                    setCharacterDetails(null);
                    onDataChange(null);
                    return;
                }

                let rating = 0;
                let rating_color = "#FFFFFF";
                if (result.mythic_plus_scores_by_season.length > 0) {
                    rating = result.mythic_plus_scores_by_season[0].scores.all;
                    rating_color = result.mythic_plus_scores_by_season[0].segments.all.color;
                }
                setCharacterDetails({
                    name: result.name,
                    character_class: result.class,
                    thumbnail_url: result.thumbnail_url,
                    profile_url: result.profile_url,
                    rating: rating,
                    rating_color: rating_color,
                });
                setError(null);
                onDataChange([...result.mythic_plus_best_runs,...result.mythic_plus_alternate_runs]);
            },
            (error) => {
                setError(error);
                setCharacterDetails(null);
                onDataChange(null);
            })
            .catch(err => setError(err))
    }

    return (
        <>
        <div className="inputPanel">
            <div className="inputDescription">Character Select: </div>
            <div className="inputField">
                <label>Region</label>
                <select name="region" onChange={(e) => setRegion(e.target.value)}>
                    <option value="us">US</option>
                    <option value="eu">EU</option>
                    <option value="kr">KR</option>
                    <option value="tw">TW</option>
                </select>
            </div>
            <div className="inputField">
                <label>Realm</label>
                <input type="text" onChange={(e) => setRealm(e.target.value)} />
            </div>
            <div className="inputField">
                <label>Character</label>
                <input type="text" onChange={(e) => setCharacter(e.target.value)} onKeyDown={handleKeyPress} />
            </div>
            <div className="inputField">
                <label>&nbsp;</label>
                <button onClick={handleFetch}>Fetch Character</button>
            </div>
        </div>
        {characterDetails !== null && <CharacterBadge {...characterDetails} />}
        {error !== null && <div className="error_message">{error.message}</div>}
        </>
    )
}

export default CharacterSelector;